# RivicQ Full Architecture Design

## Table of Contents
1. [System Overview](#system-overview)
2. [Layer Architecture](#layer-architecture)
3. [Core Modules](#core-modules)
4. [Security Architecture](#security-architecture)
5. [Data Flow](#data-flow)
6. [API Architecture](#api-architecture)
7. [Infrastructure](#infrastructure)
8. [Deployment](#deployment)

---

## 1. System Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    RIVICQ                                          │
│                         Privacy Protocol for Web3                                   │
│                              v2.0.0                                               │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    ┌─────────────────────────────────────────────────────────────────────────┐    │
│    │                         CLIENT APPLICATIONS                               │    │
│    │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │    │
│    │  │   Web    │  │   iOS    │  │ Android  │  │   API    │  │  SDK    │ │    │
│    │  │   App    │  │    App   │  │    App   │  │   Client │  │ (Lib)   │ │    │
│    │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │    │
│    └─────────────────────────────────────────────────────────────────────────┘    │
│                                        │                                            │
│                                        ▼                                            │
│    ┌─────────────────────────────────────────────────────────────────────────┐    │
│    │                          RIVICQ GATEWAY                                  │    │
│    │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐ │    │
│    │  │   Auth       │  │   Rate       │  │   Load       │  │   API    │ │    │
│    │   │   Service   │  │   Limiter    │  │   Balancer   │  │   Router │ │    │
│    │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────┘ │    │
│    └─────────────────────────────────────────────────────────────────────────┘    │
│                                        │                                            │
│           ┌────────────────────────────┼────────────────────────────┐             │
│           │                            │                            │             │
│           ▼                            ▼                            ▼             │
│    ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐          │
│    │   OSS CLUSTER    │    │ ENTERPRISE CLUSTER│    │  RELAY NETWORK  │          │
│    │                  │    │                  │    │                  │          │
│    │  • ZK Engine    │    │  • MultiSig     │    │  • Flashbots    │          │
│    │  • Merkle Tree  │    │  • Timelock     │    │  • MEV Protect  │          │
│    │  • Pool Manager │    │  • Access Ctrl  │    │  • Tx Relay     │          │
│    │  • Wallet Svc   │    │  • Audit Log   │    │                  │          │
│    │                  │    │  • Shield Pool │    │                  │          │
│    └──────────────────┘    └──────────────────┘    └──────────────────┘          │
│                                        │                                            │
│                                        ▼                                            │
│    ┌─────────────────────────────────────────────────────────────────────────┐    │
│    │                          BLOCKCHAIN LAYER                              │    │
│    │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ │    │
│    │  │ Ethereum│ │ Solana │ │  BSC   │ │Polygon │ │Arbitrum│ │Avalanche│ │    │
│    │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ │    │
│    └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              APPLICATION LAYER                                  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │
│  │   Web App   │ │  Mobile App │ │  API Client │ │    SDK      │             │
│  │  (Next.js)  │ │  (React    │ │  (REST/     │ │ (JS/TS/     │             │
│  │             │ │   Native)   │ │   GraphQL)  │ │  Swift/     │             │
│  │             │ │             │ │             │ │  Kotlin)    │             │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                              GATEWAY LAYER                                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │
│  │   AuthN/Z    │ │   WAF       │ │   Rate      │ │   API       │             │
│  │   Gateway    │ │   Filter    │ │   Limiter   │ │   Gateway   │             │
│  │             │ │             │ │             │ │             │             │
│  │  • JWT      │ │  • DDoS    │ │  • TPS      │ │  • REST     │             │
│  │  • OAuth2   │ │  • SQLi    │ │  • Volume   │ │  • GraphQL  │             │
│  │  • MFA      │ │  • XSS     │ │  • Cooldown │ │  • WebSocket│             │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                             SERVICE LAYER                                       │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                         CORE SERVICES                                    │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │   │
│  │  │   Proof     │ │   Wallet    │ │   Pool      │ │   Identity  │     │   │
│  │  │   Service   │ │   Service   │ │   Service   │ │   Service   │     │   │
│  │  │             │ │             │ │             │ │             │     │   │
│  │  │ • Generate  │ │ • Create    │ │ • Deposit   │ │ • Register  │     │   │
│  │  │ • Verify    │ │ • Sign      │ │ • Withdraw  │ │ • Auth      │     │   │
│  │  │ • Circuit   │ │ • Recovery  │ │ • Shield    │ │ • KYC       │     │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                      ENTERPRISE SERVICES                                 │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │   │
│  │  │   MultiSig  │ │  Timelock   │ │   Access    │ │   Audit     │     │   │
│  │  │   Vault     │ │   Vault     │ │   Control   │ │   Logger    │     │   │
│  │  │             │ │             │ │             │ │             │     │   │
│  │  │ • Threshold │ │ • Schedule │ │ • RBAC      │ │ • Log       │     │   │
│  │  │ • Signing   │ │ • Execute  │ │ • Policies  │ │ • Query     │     │   │
│  │  │ • Execute   │ │ • Cancel   │ │ • Audit     │ │ • Export    │     │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                       SECURITY SERVICES                                   │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │   │
│  │  │   Key      │ │  Hardware   │ │  Circuit    │ │   Compliance│     │   │
│  │  │   Rotation │ │   Wallet    │ │   Breaker   │ │   Manager   │     │   │
│  │  │             │ │             │ │             │ │             │     │   │
│  │  │ • Init     │ │ • Ledger    │ │ • Trigger   │ │ • KYC       │     │   │
│  │  │ • Approve  │ │ • Trezor    │ │ • Pause     │ │ • AML       │     │   │
│  │  │ • Execute  │ │ • Sign      │ │ • Resume    │ │ • Reports   │     │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                              CRYPTO LAYER                                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │
│  │   MiMC7     │ │  Poseidon   │ │    ECIES    │ │   Groth16   │             │
│  │   Hash      │ │   Hash      │ │   Encrypt   │ │   ZK Proof  │             │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │
│  │   ECDSA     │ │   Merkle    │ │   Batch     │ │   Signature │             │
│  │   Sign      │ │   Tree      │ │   Proofs    │ │   Scheme    │             │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                              DATA LAYER                                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │
│  │  PostgreSQL │ │   Redis     │ │    S3       │ │   IPFS      │             │
│  │             │ │             │ │             │ │             │             │
│  │ • User Data │ │ • Cache    │ │ • Proofs    │ │ • Circuits  │             │
│  │ • Tx History│ │ • Sessions │ │ • Backups   │ │ • Artifacts │             │
│  │ • Logs      │ │ • Rate Lim │ │ • Binaries  │ │ • Merkle    │             │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                           BLOCKCHAIN LAYER                                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │
│  │  Ethereum   │ │   Solana    │ │    L2s      │ │   Bridges   │             │
│  │  (Mainnet)  │ │             │ │             │ │             │             │
│  │             │ │             │ │             │ │             │             │
│  │ • Verifier  │ │ • Program   │ │ • Arbitrum  │ │ • Axelar    │             │
│  │ • Vault     │ │ • Anchor    │ │ • Optimism  │ │ • Wormhole  │             │
│  │ • Registry  │ │             │ │ • ZKsync    │ │ • LayerZero │             │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘             │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Core Modules

### 3.1 ZK Proof Engine

```
┌─────────────────────────────────────────────────────────────────┐
│                      ZK PROOF ENGINE                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐     │
│  │   MiMC7      │    │  Poseidon    │    │   Pedersen   │     │
│  │   Hash       │    │   Hash       │    │   Commit     │     │
│  └──────────────┘    └──────────────┘    └──────────────┘     │
│         │                   │                   │              │
│         └───────────────────┼───────────────────┘              │
│                             ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                   PROOF GENERATOR                        │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │   │
│  │  │  Transfer │  │  Identity  │  │   Range    │        │   │
│  │  │   Proof   │  │   Proof    │  │   Proof    │        │   │
│  │  └────────────┘  └────────────┘  └────────────┘        │   │
│  └──────────────────────────────────────────────────────────┘   │
│                             │                                   │
│                             ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  PROOF VERIFIER                          │   │
│  │                                                           │   │
│  │  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │              GROTH16 VERIFICATION                 │  │   │
│  │  │  • Load Verification Key                          │  │   │
│  │  │  • Parse Proof (π_a, π_b, π_c)                  │  │   │
│  │  │  • Check Public Signals                          │  │   │
│  │  │  • Pairing Operations                            │  │   │
│  │  └─────────────────────────────────────────────────────┘  │   │
│  └────────────────────────────────────────────────   │
│                                                                 ──────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Confidential Transaction Pool

```
┌─────────────────────────────────────────────────────────────────┐
│                   CONFIDENTIAL POOL MANAGER                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      SHIELDED POOL                        │  │
│  │                                                            │  │
│  │    ┌─────────────────────────────────────────────────┐    │  │
│  │    │              MERKLE TREE (2^20)                │    │  │
│  │    │                                                  │    │  │
│  │    │    Level 0: [leaf0, leaf1, ..., leafN]        │    │  │
│  │    │    Level 1: [hash0, hash1, ..., hash(N/2)]   │    │  │
│  │    │    Level 2: [hash0, hash1, ...]              │    │  │
│  │    │    ...                                         │    │  │
│  │    │    Level 20: [root]                            │    │  │
│  │    │                                                  │    │  │
│  │    └─────────────────────────────────────────────────┘    │  │
│  │                                                           │  │
│  │    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │  │
│  │    │  Deposits  │  │  Withdraws  │  │   Snarks    │    │  │
│  │    │  (Note 1) │  │  (Note 1)  │  │   (ZK)      │    │  │
│  │    │  (Note 2) │  │  (Note 2)  │  │             │    │  │
│  │    │  (Note N) │  │             │  │             │    │  │
│  │    └─────────────┘  └─────────────┘  └─────────────┘    │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    OPERATIONS                             │  │
│  │                                                            │  │
│  │   DEPOSIT                    WITHDRAW                     │  │
│  │   ───────                    ────────                     │  │
│  │   1. User generates         1. User creates             │  │
│  │      secret, nullifier         withdrawal request         │  │
│  │   2. Compute                 2. Generate ZK proof        │  │
│  │      commitment                (spend authority)         │  │
│  │   3. Generate ZK proof       3. Verify nullifier        │  │
│  │      (commitment)             4. Compute destination    │  │
│  │   4. Insert to tree            encrypted amount          │  │
│  │   5. Broadcast tx             5. Broadcast tx            │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 Identity System

```
┌─────────────────────────────────────────────────────────────────┐
│                     IDENTITY SYSTEM                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   IDENTITY REGISTRY                        │  │
│  │                                                            │  │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │  │
│  │   │  Identity   │    │  Identity   │    │  Identity   │  │  │
│  │   │   Hash      │    │   Hash      │    │   Hash      │  │  │
│  │   │             │    │             │    │             │  │  │
│  │   │ id_hash =   │    │ id_hash =   │    │ id_hash =   │  │  │
│  │   │  H(priv,    │    │  H(priv,    │    │  H(priv,    │  │  │
│  │   │   ephem)    │    │   ephem)    │    │   ephem)    │  │  │
│  │   └─────────────┘    └─────────────┘    └─────────────┘  │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  PROOF CHAINS                             │  │
│  │                                                            │  │
│  │   ┌────────────────────────────────────────────────────┐  │  │
│  │   │                 IDENTITY PROOF                     │  │  │
│  │   │                                                    │  │  │
│  │   │  {                                                 │  │  │
│  │   │    identityHash: 0x1234...,                       │  │  │
│  │   │    ephemeralPubKey: 0xabcd...,                   │  │  │
│  │   │    signature: {...},                             │  │  │
│  │   │    timestamp: 1699999999,                       │  │  │
│  │   │    expiration: 1700000000                        │  │  │
│  │   │  }                                               │  │  │
│  │   └────────────────────────────────────────────────────┘  │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. Security Architecture

### 4.1 Defense in Depth

```
┌─────────────────────────────────────────────────────────────────┐
│                    SECURITY ARCHITECTURE                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    PERIMETER SECURITY                     │  │
│  │                                                            │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐  │  │
│  │  │   WAF    │  │  DDoS    │  │   WAF    │  │  CDN   │  │  │
│  │  │          │  │  Guard   │  │          │  │        │  │  │
│  │  │ • SQLi   │  │          │  │ • XSS    │  │ • TLS  │  │  │
│  │  │ • XSS    │  │          │  │ • CSRF   │  │ • HSTS │  │  │
│  │  │ • LFI    │  │          │  │ • RCE    │  │        │  │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └─────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    APPLICATION SECURITY                    │  │
│  │                                                            │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐  │  │
│  │  │   Auth   │  │  Access  │  │   Rate   │  │   Input │  │  │
│  │  │  Gateway │  │  Control │  │  Limiter │  │ Validation│ │  │
│  │  │          │  │          │  │          │  │         │  │  │
│  │  │ • OAuth2 │  │ • RBAC   │  │ • TPS    │  │ • Sanitize│ │  │
│  │  │ • JWT    │  │ • ABAC   │  │ • Volume │  │ • Type   │  │  │
│  │  │ • MFA    │  │ • Policies│ │ • Cooldown│ │ • Bounds │  │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └─────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                     DATA SECURITY                         │  │
│  │                                                            │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐  │  │
│  │  │  Field   │  │   Data   │  │   Key    │  │ Secret  │  │  │
│  │  │  Level   │  │  At Rest │  │  Vault   │  │ Manager │  │  │
│  │  │  Enc     │  │  Enc     │  │          │  │         │  │  │
│  │  │          │  │          │  │          │  │         │  │  │
│  │  │ • AES256 │  │ • AWS    │  │ • HSM    │  │ • Rotat │  │  │
│  │  │ • TLS    │  │   KMS    │  │ • AWSSM  │  │ • Audit │  │  │
│  │  │          │  │          │  │          │  │ • Backup│  │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └─────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    OPERATIONAL SECURITY                    │  │
│  │                                                            │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐  │  │
│  │  │  Audit   │  │  Key     │  │ Incident │  │  Backup │  │  │
│  │  │  Logging │  │ Rotation │  │ Response │  │ & DR    │  │  │
│  │  │          │  │          │  │          │  │         │  │  │
│  │  │ • All    │  │ • Auto   │  │ • Alert  │  │ • Daily │  │  │
│  │  │ • Immutable│ │ • Schedule│ │ • SOC    │  │ • Test  │  │  │
│  │  │ • 7yr    │  │ • Guardian│ │ • Auto   │  │ • Geo   │  │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └─────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 Key Management

```
┌─────────────────────────────────────────────────────────────────┐
│                    KEY MANAGEMENT HIERARCHY                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                         ┌─────────────┐                          │
│                         │     KMS     │                          │
│                         │  (AWS/HSM)  │                          │
│                         └──────┬──────┘                          │
│                                │                                 │
│              ┌─────────────────┼─────────────────┐               │
│              │                 │                 │               │
│              ▼                 ▼                 ▼               │
│    ┌─────────────────┐ ┌─────────────────┐ ┌───────────────┐    │
│    │  User Keys      │ │  Signing Keys  │ │  ZK Keys      │    │
│    │                 │ │                 │ │               │    │
│    │  • Wallet Priv  │ │  • MultiSig    │ │  • Proving    │    │
│    │  • Recovery    │ │  • Vault Auth  │ │  • Verifier   │    │
│    │  • Ephemeral   │ │  • Identity    │ │  • Setup      │    │
│    └────────┬────────┘ └────────┬────────┘ └───────┬───────┘    │
│             │                   │                   │             │
│             │         ┌─────────┴─────────┐         │             │
│             │         │                   │         │             │
│             ▼         ▼                   ▼         ▼             │
│    ┌─────────────────────────────────────────────────────────┐   │
│    │                   KEY LIFECYCLE                         │   │
│    │                                                          │   │
│    │   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌───────┐  │   │
│    │   │ Generate│──▶│  Store  │──▶│  Rotate │──▶│ Revoke│  │   │
│    │   └─────────┘   └─────────┘   └─────────┘   └───────┘  │   │
│    │       │             │             │             │        │   │
│    │       ▼             ▼             ▼             ▼        │   │
│    │   [Entropy]    [HSM/KMS]   [Scheduled]    [Emergency]   │   │
│    │                                                          │   │
│    └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. Data Flow

### 5.1 Confidential Transfer Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     CONFIDENTIAL TRANSFER FLOW                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ALICE                                    RIVICQ                   BOB       │
│  (Sender)                                  SERVER                  (Recipient) │
│     │                                         │                        │       │
│     │  1. Generate Secrets                     │                        │       │
│     │     • secret (r)                        │                        │       │
│     │     • nullifier (n)                     │                        │       │
│     │     • salt (s)                          │                        │       │
│     │                                         │                        │       │
│     │────────▶ Compute Commitment              │                        │       │
│     │        C = H(amount, r, s)              │                        │       │
│     │                                         │                        │       │
│     │  2. Generate ZK Proof                   │                        │       │
│     │        π = ZK.{C, amount, recipient}    │                        │       │
│     │                                         │                        │       │
│     │  3. Send to Relay ──────────────────▶  │                        │       │
│     │        {C, π, recipient_enc}            │                        │       │
│     │                                         │                        │       │
│     │                                    ┌────┴────┐                   │       │
│     │                                    │ VERIFY  │                   │       │
│     │                                    │  π, C   │                   │       │
│     │                                    │ Check   │                   │       │
│     │                                    │ Nullifier│                  │       │
│     │                                    └────┬────┘                   │       │
│     │                                         │                        │       │
│     │                                    ┌────┴────┐                   │       │
│     │                                    │ INSERT  │                   │       │
│     │                                    │ Merkle  │                   │       │
│     │                                    │  Tree   │                   │       │
│     │                                    └────┬────┘                   │       │
│     │                                         │                        │       │
│     │                                    ┌────┴────┐                   │       │
│     │                                    │ BROADCAST│                  │       │
│     │                                    │  to      │                  │       │
│     │                                    │ Blockchain│                  │       │
│     │                                    └────┬────┘                   │       │
│     │                                         │                        │       │
│     │◀─────────────────── Receipt ────────────│                        │       │
│     │        {tx_hash, leaf_index}           │                        │       │
│     │                                         │                        │       │
│     │                                         │◀─── 3. Withdraw ──────│       │
│     │                                         │      {π, recipient}    │       │
│     │                                         │                        │       │
│     │                                         │        Verify π        │       │
│     │                                         │        Check nullifier │       │
│     │                                         │        Release funds   │       │
│     │                                         │                        │       │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Enterprise Multi-Sig Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        MULTI-SIG TRANSACTION FLOW                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   USER A              USER B              USER C           RIVICQ              │
│  (Creator)          (Signer 1)          (Signer 2)         SERVER             │
│     │                   │                   │                │               │
│     │  1. Create TX    │                   │                │               │
│     │──────▶{to, value, data}              │                │               │
│     │                   │                   │                │               │
│     │──────▶ Broadcast to network          │                │               │
│     │                   │                   │                │               │
│     │              ┌────┴────┐              │                │               │
│     │              │ pending │              │                │               │
│     │              │  tx     │              │                │               │
│     │              └────┬────┘              │                │               │
│     │                   │                   │                │               │
│     │  2. Sign (M-of-N)│                   │                │               │
│     │      SIG_A       │                   │                │               │
│     │──────────────────│───────────────────│───▶           │               │
│     │                   │                   │                │               │
│     │                   │  3. Sign (M-of-N) │                │               │
│     │                   │      SIG_B        │                │               │
│     │                   │───────────────────│───▶           │               │
│     │                   │                   │                │               │
│     │                   │              ┌────┴────┐          │               │
│     │                   │              │ THRESHOLD│          │               │
│     │                   │              │ MET?     │          │               │
│     │                   │              │  (2/3)   │          │               │
│     │                   │              └────┬────┘          │               │
│     │                   │                   │                │               │
│     │                   │                   │  4. Execute   │               │
│     │                   │                   │───────▶       │               │
│     │                   │                   │  {exec(tx)}   │               │
│     │                   │                   │                │               │
│     │                   │                   │          ┌────┴────┐          │
│     │                   │                   │          │ BROADCAST│          │
│     │                   │                   │          │  to      │          │
│     │                   │                   │          │ Blockchain│          │
│     │                   │                   │          └────┬────┘          │
│     │                   │                   │                │               │
│     │◀─────────────────│──────────────────│────────────────│               │
│     │        TX CONFIRMATION               │                │               │
│     │        {tx_hash, status}             │                │               │
│     │                   │                   │                │               │
│     └───────────────────┴───────────────────┴────────────────┘               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. API Architecture

### 6.1 API Gateway Structure

```
┌─────────────────────────────────────────────────────────────────┐
│                        API GATEWAY                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    ROUTING LAYER                          │  │
│  │                                                            │  │
│  │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │  │
│  │   │    REST     │  │  GraphQL    │  │  WebSocket  │    │  │
│  │   │   /v1/*     │  │   /graphql  │  │   /ws       │    │  │
│  │   └─────────────┘  └─────────────┘  └─────────────┘    │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   MIDDLEWARE CHAIN                         │  │
│  │                                                            │  │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │  │
│  │   │   Auth   │─▶│   Rate   │─▶│  Cache   │─▶│   Log    │ │  │
│  │   │          │  │  Limiter │  │          │  │          │ │  │
│  │   └──────────┘  └──────────┘  └──────────┘  └──────────┘ │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    SERVICE ROUTER                         │  │
│  │                                                            │  │
│  │   ┌─────────────────────────────────────────────────────┐ │  │
│  │   │                 OSS SERVICES                       │ │  │
│  │   │  ┌───────────┐ ┌───────────┐ ┌───────────┐        │ │  │
│  │   │  │  /proof   │ │ /wallet   │ │  /pool    │        │ │  │
│  │   │  │  /verify  │ │  /sign    │ │  /deposit │        │ │  │
│  │   │  │  /circuit │ │  /verify  │ │  /withdraw│        │ │  │
│  │   │  └───────────┘ └───────────┘ └───────────┘        │ │  │
│  │   └─────────────────────────────────────────────────────┘ │  │
│  │                                                            │  │
│  │   ┌─────────────────────────────────────────────────────┐ │  │
│  │   │              ENTERPRISE SERVICES                    │ │  │
│  │   │  ┌───────────┐ ┌───────────┐ ┌───────────┐        │ │  │
│  │   │  │ /multisig│ │ /timelock│ │ /access   │        │ │  │
│  │   │  │ /vault   │ │ /schedule│ │ /roles    │        │ │  │
│  │   │  │ /execute │ │ /execute │ │ /policies │        │ │  │
│  │   │  └───────────┘ └───────────┘ └───────────┘        │ │  │
│  │   │  ┌───────────┐ ┌───────────┐ ┌───────────┐        │ │  │
│  │   │  │ /audit   │ │ /compliance│ │ /mev     │        │ │  │
│  │   │  │ /logs    │ │ /kyc      │ │ /protect  │        │ │  │
│  │   │  │ /export  │ │ /aml      │ │ /relay   │        │ │  │
│  │   │  └───────────┘ └───────────┘ └───────────┘        │ │  │
│  │   └─────────────────────────────────────────────────────┘ │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 API Endpoints

```
┌────────────────────────────────────────────────────────────────────────────┐
│                           RIVICQ API ENDPOINTS                             │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                        CORE API (Open Source)                         │ │
│  │                                                                       │ │
│  │  POST   /v1/proof/generate          Generate ZK proof                │ │
│  │  POST   /v1/proof/verify            Verify ZK proof                  │ │
│  │  POST   /v1/proof/circuit/load      Load circuit WASM               │ │
│  │                                                                       │ │
│  │  POST   /v1/wallet/create          Create wallet                    │ │
│  │  POST   /v1/wallet/import           Import wallet                   │ │
│  │  POST   /v1/wallet/sign             Sign message                     │ │
│  │  GET    /v1/wallet/balance          Get balance                      │ │
│  │                                                                       │ │
│  │  POST   /v1/pool/deposit            Deposit to shielded pool        │ │
│  │  POST   /v1/pool/withdraw           Withdraw from shielded pool     │ │
│  │  GET    /v1/pool/merkle/root        Get Merkle root                │ │
│  │  GET    /v1/pool/merkle/proof       Get Merkle proof               │ │
│  │  GET    /v1/pool/stats              Get pool statistics            │ │
│  │                                                                       │ │
│  │  POST   /v1/identity/register       Register identity               │ │
│  │  POST   /v1/identity/prove           Generate identity proof        │ │
│  │  POST   /v1/identity/verify          Verify identity proof           │ │
│  │                                                                       │ │
│  │  POST   /v1/encryption/encrypt       Encrypt data (ECIES)           │ │
│  │  POST   /v1/encryption/decrypt       Decrypt data                   │ │
│  │                                                                       │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                      ENTERPRISE API                                 │ │
│  │                                                                       │ │
│  │  MULTI-SIG VAULT                                                    │ │
│  │  POST   /v1/enterprise/multisig/create     Create MultiSig wallet   │ │
│  │  POST   /v1/enterprise/multisig/tx         Create transaction       │ │
│  │  POST   /v1/enterprise/multisig/sign       Add signature            │ │
│  │  POST   /v1/enterprise/multisig/execute   Execute transaction       │ │
│  │  GET    /v1/enterprise/multisig/status    Get transaction status    │ │
│  │                                                                       │ │
│  │  TIMELOCK VAULT                                                     │ │
│  │  POST   /v1/enterprise/timelock/schedule   Schedule release         │ │
│  │  POST   /v1/enterprise/timelock/cancel    Cancel schedule         │ │
│  │  POST   /v1/enterprise/timelock/execute    Execute release         │ │
│  │  GET    /v1/enterprise/timelock/list       List schedules          │ │
│  │                                                                       │ │
│  │  ACCESS CONTROL                                                     │ │
│  │  POST   /v1/enterprise/access/role         Create role              │ │
│  │  POST   /v1/enterprise/access/grant       Grant role               │ │
│  │  POST   /v1/enterprise/access/revoke      Revoke role              │ │
│  │  GET    /v1/enterprise/access/check       Check permission         │ │
│  │                                                                       │ │
│  │  AUDIT & COMPLIANCE                                                │ │
│  │  POST   /v1/enterprise/audit/log          Create audit log         │ │
│  │  GET    /v1/enterprise/audit/query       Query audit logs          │ │
│  │  GET    /v1/enterprise/audit/export      Export logs               │ │
│  │  GET    /v1/enterprise/compliance/report Generate compliance rpt  │ │
│  │                                                                       │ │
│  │  KEY MANAGEMENT                                                     │ │
│  │  POST   /v1/enterprise/key/rotate        Initiate key rotation    │ │
│  │  POST   /v1/enterprise/key/approve       Approve rotation         │ │
│  │  POST   /v1/enterprise/key/emergency      Emergency key revoke     │ │
│  │                                                                       │ │
│  │  RATE LIMITING                                                      │ │
│  │  GET    /v1/enterprise/ratelimit/status  Get rate limit status     │ │
│  │  POST   /v1/enterprise/ratelimit/config  Configure rate limits     │ │
│  │                                                                       │ │
│  │  CIRCUIT BREAKER                                                    │ │
│  │  POST   /v1/enterprise/breaker/trigger   Trigger circuit breaker  │ │
│  │  POST   /v1/enterprise/breaker/reset     Reset circuit breaker     │ │
│  │  GET    /v1/enterprise/breaker/status    Get breaker status        │ │
│  │                                                                       │ │
│  │  MEV PROTECTION                                                    │ │
│  │  POST   /v1/enterprise/mev/protect        Submit protected tx      │ │
│  │  GET    /v1/enterprise/mev/status        Get MEV protection status│ │
│  │                                                                       │ │
│  │  SOCIAL RECOVERY                                                   │ │
│  │  POST   /v1/enterprise/recovery/init     Initiate recovery        │ │
│  │  POST   /v1/enterprise/recovery/approve   Guardian approval        │ │
│  │  POST   /v1/enterprise/recovery/execute   Execute recovery         │ │
│  │                                                                       │ │
│  │  CROSS-CHAIN                                                        │ │
│  │  POST   /v1/enterprise/crosschain/verify  Verify cross-chain proof │ │
│  │  POST   /v1/enterprise/crosschain/bridge  Initiate bridge tx       │ │
│  │                                                                       │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Infrastructure

### 7.1 Cloud Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           INFRASTRUCTURE ARCHITECTURE                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                              ┌─────────────────┐                               │
│                              │   AWS ROUTE 53 │                               │
│                              │      (DNS)      │                               │
│                              └────────┬────────┘                               │
│                                       │                                        │
│                                       ▼                                        │
│                              ┌─────────────────┐                               │
│                              │  CLOUDFRONT    │                               │
│                              │     (CDN)       │                               │
│                              └────────┬────────┘                               │
│                                       │                                        │
│                                       ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      APPLICATION LOAD BALANCER                         │   │
│  │                                                                       │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │   │
│  │  │   WEB TIER │ │   API TIER  │ │  ADMIN TIER │ │  WS TIER   │     │   │
│  │  │  (EC2 ASG) │ │ (EC2 ASG)   │ │ (EC2 ASG)   │ │ (EC2 ASG)  │     │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                       │                                        │
│              ┌────────────────────────┼────────────────────────┐               │
│              │                        │                        │               │
│              ▼                        ▼                        ▼               │
│  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐ │
│  │    OSS CLUSTER      │    │  ENTERPRISE CLUSTER │    │   RELAY NETWORK     │ │
│  │                     │    │                     │    │                     │ │
│  │  ┌───────────────┐  │    │  ┌───────────────┐  │    │  ┌───────────────┐  │ │
│  │  │ Proof Worker  │  │    │  │ MultiSig Svc  │  │    │  │  Flashbots    │  │ │
│  │  │   (GPU/FPGA) │  │    │  │               │  │    │  │   Relayer    │  │ │
│  │  └───────────────┘  │    │  └───────────────┘  │    │  └───────────────┘  │ │
│  │  ┌───────────────┐  │    │  ┌───────────────┐  │    │  ┌───────────────┐  │ │
│  │  │ Wallet Worker │  │    │  │ Timelock Svc  │  │    │  │    MEV        │  │ │
│  │  │               │  │    │  │               │  │    │  │   Protector   │  │ │
│  │  └───────────────┘  │    │  └───────────────┘  │    │  └───────────────┘  │ │
│  │  ┌───────────────┐  │    │  ┌───────────────┐  │    │                     │ │
│  │  │ Pool Manager  │  │    │  │ Audit Logger  │  │    │                     │ │
│  │  │               │  │    │  │               │  │    │                     │ │
│  │  └───────────────┘  │    │  └───────────────┘  │    │                     │ │
│  └─────────────────────┘    └─────────────────────┘    └─────────────────────┘ │
│              │                        │                        │               │
│              └────────────────────────┼────────────────────────┘               │
│                                       │                                        │
│                                       ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                            DATA LAYER                                   │   │
│  │                                                                       │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │   │
│  │  │  PostgreSQL │  │    Redis    │  │     S3      │  │    IPFS     │ │   │
│  │  │  (Primary)  │  │  (Cluster)  │  │             │  │             │ │   │
│  │  │             │  │             │  │ • Proofs    │  │ • Circuits   │ │   │
│  │  │ • Users     │  │ • Cache     │  │ • Backups   │  │ •Artifacts  │ │   │
│  │  │ • TX History│  │ • Sessions  │  │ • Binaries  │  │             │ │   │
│  │  │ • Logs      │  │ • Rate Lim  │  │ • Keys      │  │             │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │   │
│  │        │                  │                  │                  │       │   │
│  │        └──────────────────┴──────────────────┴──────────────────┘       │   │
│  │                                    │                                      │   │
│  │                                    ▼                                      │   │
│  │                          ┌─────────────────┐                              │   │
│  │                          │  AWS KMS / HSM  │                              │   │
│  │                          │                 │                              │   │
│  │                          │ • Key Storage   │                              │   │
│  │                          │ • Signing Keys  │                              │   │
│  │                          │ • ZK Keys       │                              │   │
│  │                          └─────────────────┘                              │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Kubernetes Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        KUBERNETES CLUSTER ARCHITECTURE                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      NAMESPACES                                        │   │
│  │                                                                         │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐              │   │
│  │  │  rivicq  │  │ enterprise│  │  monitoring│ │  security│              │   │
│  │  │   -oss   │  │          │  │           │ │          │              │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      WORKLOADS                                          │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │                    DEPLOYMENTS                                 │   │   │
│  │  │                                                                  │   │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │   │   │
│  │  │  │  api-gateway│  │ proof-engine│  │ pool-manager│          │   │   │
│  │  │  │    3 pods   │  │   5 pods    │  │   3 pods   │          │   │   │
│  │  │  │  CPU: 500m │  │  GPU: 2     │  │  CPU: 1    │          │   │   │
│  │  │  │  Mem: 512M │  │  Mem: 8Gi   │  │  Mem: 2Gi  │          │   │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘          │   │   │
│  │  │                                                                  │   │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │   │   │
│  │  │  │  wallet-svc │  │ multi-sig   │  │ timelock    │          │   │   │
│  │  │  │    3 pods   │  │   3 pods    │  │   3 pods   │          │   │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘          │   │   │
│  │  │                                                                  │   │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │   │   │
│  │  │  │ audit-logger│  │ access-ctrl │  │   mev-relay │          │   │   │
│  │  │  │    2 pods   │  │   3 pods    │  │   5 pods   │          │   │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘          │   │   │
│  │  │                                                                  │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │                      STATEFULSETS                              │   │   │
│  │  │                                                                  │   │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │   │   │
│  │  │  │  postgres   │  │   redis     │  │  ipfs       │          │   │   │
│  │  │  │  (Primary)  │  │  (Cluster)  │  │   (Cluster) │          │   │   │
│  │  │  │  1 pod      │  │  6 pods     │  │   4 pods   │          │   │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘          │   │   │
│  │  │                                                                  │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      SERVICES & INGRESS                                 │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │                       SERVICES                                  │   │   │
│  │  │                                                                  │   │   │
│  │  │  ClusterIP:    api-gateway   (internal)                        │   │   │
│  │  │  ClusterIP:    proof-engine   (internal)                        │   │   │
│  │  │  ClusterIP:    postgres       (internal)                        │   │   │
│  │  │  ClusterIP:    redis           (internal)                        │   │   │
│  │  │                                                                  │   │   │
│  │  │  LoadBalancer: api-rivicq      (external TCP:443)               │   │   │
│  │  │                                                                  │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Deployment

### 8.1 Docker Compose (Development)

```yaml
version: '3.8'

services:
  api-gateway:
    image: rivicq/api-gateway:v2.0.0
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - RIVICQ_TIER=${RIVICQ_TIER}
      - DATABASE_URL=postgresql://rivicq:password@postgres:5432/rivicq
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis

  proof-engine:
    image: rivicq/proof-engine:v2.0.0
    environment:
      - CIRCUIT_PATH=/circuits
      - PROVING_KEY_PATH=/keys
    volumes:
      - ./circuits:/circuits
      - ./keys:/keys

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_USER=rivicq
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=rivicq

  redis:
    image: redis:7-alpine

  ipfs:
    image: ipfs/kubo:latest
```

### 8.2 Kubernetes (Production)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rivicq-api-gateway
  namespace: rivicq
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api-gateway
  template:
    spec:
      containers:
      - name: api-gateway
        image: rivicq/api-gateway:v2.0.0
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi
        env:
        - name: RIVICQ_TIER
          value: "enterprise"
        - name: LICENSE_KEY
          valueFrom:
            secretKeyRef:
              name: rivicq-secrets
              key: license-key
```

---

## Summary

| Component | Technology |
|-----------|-------------|
| Frontend | Next.js 14, React 18, TypeScript |
| API Gateway | Kong / AWS API Gateway |
| Auth | OAuth2 + JWT + MFA |
| Database | PostgreSQL 15 |
| Cache | Redis Cluster |
| Storage | S3 + IPFS |
| Security | AWS KMS + HSM |
| Container | Docker + Kubernetes |
| Cloud | AWS |
| CDN | CloudFront |
| DNS | Route 53 |
| Monitoring | Prometheus + Grafana |
| Logging | ELK Stack |
